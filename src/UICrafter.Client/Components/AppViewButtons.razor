@using Google.Protobuf
@using Google.Protobuf.WellKnownTypes
@using UICrafter.Core.UIComponents
@using UICrafter.Core.AppView
@using UICrafter.Core.Utility

<MudStack Row="true">
    <MudTextField @bind-Value="@AppViewName" Label="App-view name" Variant="Variant.Outlined"></MudTextField>

    <MudButtonGroup Variant="Variant.Outlined" Class="ma-auto">
        <MudIconButton Icon="@Icons.Material.Filled.Save" Size="Size.Large" OnClick="@SaveAppView" />
        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Large" OnClick="@DeleteAppView" />
        <MudIconButton Icon="@Icons.Material.Filled.Clear" Size="Size.Large" OnClick="@ClearAppView" />
        <MudIconButton Icon="@Icons.Material.Filled.Download" Size="Size.Large" OnClick="@LoadAppView" />
    </MudButtonGroup>
</MudStack>

@code {
    [Inject]
    private IAppViewRepository AppViewRepository { get; set; } = default!;

    private String AppViewName { get; set; } = String.Empty;

    [Parameter]
    public required List<UIComponent> UIComponents { get; set; }

    private UIComponent? _internalSelectedComponent;
    [Parameter]
    public required UIComponent? SelectedComponent
    {
        get => _internalSelectedComponent;
        set
        {
            if (SelectedComponentChanged.HasDelegate && value != _internalSelectedComponent)
            {
                _internalSelectedComponent = value;
                SelectedComponentChanged.InvokeAsync(value);
            }
        }
    }
    [Parameter]
    public required EventCallback<UIComponent?> SelectedComponentChanged { get; set; }

    private MudDropContainer<UIComponent>? _internalDropContainer;
    [Parameter]
    public required MudDropContainer<UIComponent>? DropContainer
    {
        get => _internalDropContainer;
        set
        {
            if (DropContainerChanged.HasDelegate && value != _internalDropContainer)
            {
                _internalDropContainer = value;
                DropContainerChanged.InvokeAsync(value);
            }
        }
    }
    [Parameter]
    public required EventCallback<MudDropContainer<UIComponent>?> DropContainerChanged { get; set; }

    private async Task SaveAppView()
    {
        var uiComponentList = new UIComponentList();
        uiComponentList.UIComponents.AddRange(UIComponents);

        var serializedContent = uiComponentList.ToByteString();

        var appView = new AppView
            {
                UserId = "User123",
                Name = AppViewName,
                Content = serializedContent
            };

        try
        {
            var response = await AppViewRepository.CreateAppViewAsync(appView);
        }
        catch (Exception)
        {
            
        }

        await Task.Delay(1000);
        Console.WriteLine("AppView saved.");
    }

    private async Task DeleteAppView()
    {
        await Task.Delay(1000);
        Console.WriteLine("AppView deleted.");
    }

    private void ClearAppView()
    {
        if (UIComponents.Count == 0) return;

        UIComponents.Clear();
        SelectedComponent = null;
        DropContainer?.Refresh();
    }

    private async Task LoadAppView()
    {
        await Task.Delay(1000);
        Console.WriteLine("AppView loaded.");
    }
}
