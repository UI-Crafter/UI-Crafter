@using UICrafter.Core.Models

<MudContainer MaxWidth="MaxWidth.Small">
    <MudDropContainer T="proto_UIComponent" @ref="DropContainer" Items="UIComponents" ItemsSelector="@((item,dropzone) => item.DropZoneID == dropzone)" ItemDropped="ComponentUpdated" Class="d-flex flex-wrap flex-grow-1">
        <ChildContent>
            <MudDropZone T="proto_UIComponent" Identifier="Drop Zone 1" AllowReorder="true" Class="rounded mud-background-gray pa-2 flex-grow-1 overflow-auto" Style="height: 45rem;">
            </MudDropZone>
        </ChildContent>
        <ItemRenderer>
            @if (context.ComponentCase == proto_UIComponent.ComponentOneofCase.Button)
            {
                <MudButton Class="mb-2" Variant="Variant.Filled" @onfocus="()=>SelectComponent(context)">@context.Button.Label</MudButton>
            }
            else if (context.ComponentCase == proto_UIComponent.ComponentOneofCase.InputField)
            {
                <MudTextField @bind-Value="@context.InputField.Value" Class="mb-2" Label="@context.InputField.Label" Variant="Variant.Outlined" @onfocus="()=>SelectComponent(context)"></MudTextField>
            }
            else if (context.ComponentCase == proto_UIComponent.ComponentOneofCase.Textbox)
            {
                <MudTextField @bind-Value="@context.Textbox.Content" Label="@context.Textbox.Label" ReadOnly="true" ShrinkLabel="true" Lines=@context.Textbox.NumberOfLines Variant="Variant.Outlined" @onfocus="()=>SelectComponent(context)" />
            }
            else
            {
                <MudPaper Elevation="4" Class="pa-4 my-4">Unknown Component</MudPaper>
            }
        </ItemRenderer>
    </MudDropContainer>
</MudContainer>

@code {
    [Parameter]
    public required List<proto_UIComponent> UIComponents { get; set; }

    private proto_UIComponent? _internalSelectedComponent;
    [Parameter]
    public required proto_UIComponent? SelectedComponent
    {
        get => _internalSelectedComponent;
        set
        {
            if (SelectedComponentChanged.HasDelegate && value != _internalSelectedComponent)
            {
                _internalSelectedComponent = value;
                SelectedComponentChanged.InvokeAsync(value);
            }
        }
    }
    [Parameter]
    public required EventCallback<proto_UIComponent?> SelectedComponentChanged { get; set; }

    private MudDropContainer<proto_UIComponent>? _internalDropContainer;
    [Parameter]
    public required MudDropContainer<proto_UIComponent>? DropContainer
    {
        get => _internalDropContainer;
        set
        {
            if(DropContainerChanged.HasDelegate && value != _internalDropContainer)
            {
                _internalDropContainer = value;
                DropContainerChanged.InvokeAsync(value);
            }
        }
    }
    [Parameter]
    public required EventCallback<MudDropContainer<proto_UIComponent>?> DropContainerChanged { get; set; }

    private void SelectComponent(proto_UIComponent component) => SelectedComponent = component;

    private void ComponentUpdated(MudItemDropInfo<proto_UIComponent> component)
    {
        if (component is null || component.Item is null) return;

        int oldIndex = UIComponents.IndexOf(component.Item);
        int newIndex = component.IndexInZone;

        if (oldIndex != newIndex)
        {
            var tmp = UIComponents[oldIndex];
            UIComponents.RemoveAt(oldIndex);
            UIComponents.Insert(newIndex, tmp);
            // Console.WriteLine("Old: " + oldIndex + "\n" + "New: " + newIndex);
        }

        component.Item.DropZoneID = component.DropzoneIdentifier;
    }
}
