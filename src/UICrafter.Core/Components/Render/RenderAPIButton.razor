@using System.Text.RegularExpressions
@inherits BaseAPIButton
@inject IHttpClientProvider HttpClientProvider
@inject ISnackbar Snackbar

@{
    base.BuildRenderTree(__builder);
}

@code {
    [Parameter]
    public required UIComponent Button { get; set; }

    [CascadingParameter]
    public required JsonPublisher JSONPublisher { get; set; }

    [CascadingParameter]
    public required InputFieldPublisher inputFieldPublisher { get; set; }

    private string ModifiedURL { get; set; } = string.Empty;
    private Dictionary<string, string> LogicalNamesPairing = [];

    private bool _processing = false;

    protected override void OnInitialized()
    {
        ButtonText = Button.Button.Label;
        OnClick = EventCallback.Factory.Create<MouseEventArgs>(this, CallApi);
        GetLogicalNamesFromURL();
    }

    private void GetLogicalNamesFromURL()
    {
        if (string.IsNullOrEmpty(Button.Button.URL))
        {
            return;
        }

        var url = Button.Button.URL;

        var matches = Regex.Matches(url, @"\{([^}]+)\}");

        foreach (Match match in matches)
        {
            var logicalName = match.Groups[1].Value;
            LogicalNamesPairing.Add(logicalName, "");
            Log.Information($"Logical Name: {logicalName}");
            inputFieldPublisher.Subscribe(logicalName, UpdateURL);
        }
    }

    private void UpdateURL(string logicalName, string value)
    {
        if (LogicalNamesPairing.ContainsKey(logicalName))
        {
            LogicalNamesPairing[logicalName] = value;
        }
        Log.Information("Changed URL storage");
    }

    private async Task CallApi()
    {
        ModifiedURL = Button.Button.URL;

        if (_processing)
        {
            return;
        }

        if (string.IsNullOrEmpty(ModifiedURL))
        {
            ButtonColor = Color.Error;
            DisplaySnackbar("Button URL is not set");
            return;
        }

        foreach (var pair in LogicalNamesPairing)
        {
            ModifiedURL = ModifiedURL.Replace($"{{{pair.Key}}}", pair.Value);
        }

        var httpClient = HttpClientProvider.GetDefaultHttpClient();
        try
        {
            Log.Information(ModifiedURL);
            var response = await httpClient.GetAsync(ModifiedURL);

            if (response.IsSuccessStatusCode)
            {
                var responseData = await response.Content.ReadAsStringAsync(); ;

          
                ButtonColor = Color.Success;

                
                JSONPublisher.NotifySubscribers(Button.Guid, responseData);
            }
            else
            {
                ButtonColor = Color.Error;

                var errorMessage = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error: {errorMessage}");
            }
            Log.Information(((int)response.StatusCode).ToString());
            DisplaySnackbar(((int)response.StatusCode).ToString());
        }
        catch (Exception ex)
        {
            ButtonColor = Color.Error;
            Console.WriteLine($"Exception: {ex.Message}");
            DisplaySnackbar($"{ex.Message}");
        }
        finally
        {
            _processing = false;
            //ADD Snackbar class or razor component
        }
    }

    private void Dispose()
    {
        foreach (var pair in LogicalNamesPairing)
        {
            inputFieldPublisher.Unsubscribe(pair.Key, UpdateURL);
        }
    }

    private void DisplaySnackbar(string responseCode)
    {
        switch (responseCode)
        {
            case "200":
                Snackbar.Add("Success", Severity.Success);
                break;
            case "400":
                Snackbar.Add("Bad Request", Severity.Error);
                break;
            case "401":
                Snackbar.Add("Unauthorized", Severity.Error);
                break;
            case "403":
                Snackbar.Add("Forbidden", Severity.Error);
                break;
            case "404":
                Snackbar.Add("Not Found", Severity.Error);
                break;
            case "500":
                Snackbar.Add("Internal Server Error", Severity.Error);
                break;
            default:
                Snackbar.Add(responseCode, Severity.Error);
                break;
        }
    }
}
