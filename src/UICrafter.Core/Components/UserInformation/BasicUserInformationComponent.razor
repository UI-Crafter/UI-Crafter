@using System.Security.Claims
@attribute [Authorize]



<MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">
    <MudPaper Class="pa-4 my-2">
        <MudText Typo="Typo.h4">User Profile</MudText>
        <MudDivider Class="my-1" DividerType="DividerType.FullWidth" Style="padding: 1px 0;" />

        <MudText Typo="Typo.h6">Name:</MudText>
        <MudText>@User.GetName()</MudText>

        <MudText Typo="Typo.h6">Email:</MudText>
        <MudText>@User.GetEmail()</MudText>
    </MudPaper>

    <MudPaper Class="pa-4 my-2 relative">
        <CenterLoading Visible="_isLoading" Overlay />
        <MudList T="string">
            
            <MudListSubheader>
                You have @AppViews.Count AppViews
            </MudListSubheader>
            @foreach (var view in AppViews)
            {
                <MudListItem Text=@view.Name Href=@($"appview/{view.Id}") />
            }
        </MudList>
    </MudPaper>
</MudContainer>

@code {
    [Inject] private IAppViewRepository AppViewRepository { get; set; } = default!;

    private IList<AppViewMetadata> AppViews { get; set; } = [];

    private bool _isLoading { get; set; } = true;

    [CascadingParameter]
    private Task<AuthenticationState> AuthState { get; set; } = default!;
    private ClaimsPrincipal User { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState;
        if (authState is not null)
        {
            User = authState.User;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            AppViews = await AppViewRepository.GetAppViewMetadata() ?? new List<AppViewMetadata>();
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
}
