@page "/appview/{viewId:long?}"

@using UICrafter.Mobile.Components.UIComponents
@inject IAppViewRepository AppViewRepository
@inject NavigationManager NavigationManager

<PageTitle>@appView.Name</PageTitle>


<div style=@(!viewId.HasValue ? null : "display: none;")>
    <LoadMetaDataMobile />
</div>
@if (!viewId.HasValue)
{
    return;
}


@if (_isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    @if (viewId.HasValue && componentList != null && componentList.UIComponents.Any())
    {
        <CascadingValue Value="stupidStore">
            @foreach (var component in componentList.UIComponents)
            {
                @switch (component.ComponentCase)
                {
                    case UIComponent.ComponentOneofCase.Button:
                        <PocButtonNoMistakes Button="component" />
                        break;
                    case UIComponent.ComponentOneofCase.InputField:
                        <PocAPIParamInputField InputField="component" />
                        break;
                    case UIComponent.ComponentOneofCase.Textbox:
                        <PocTextBox Textbox="component" />
                        break;
                    default:
                        // Handle unknown components if necessary
                        break;
                }
            }
        </CascadingValue>
    }
    else
    {
        <MudText Typo="Typo.body1">
            No components to display.
        </MudText>
    }
}

@code {
    [Parameter]
    public long? viewId { get; set; }
    private AppView? appView;

    private UIComponentList componentList = new UIComponentList();
    private StupidStore stupidStore = new StupidStore();  // Shared store for updating TextBoxes

    private long? _oldId;
    private bool _isLoading = false;

    protected override async Task OnParametersSetAsync()
    {
        if (!viewId.HasValue)
        {
            return;
        }

        _isLoading = true;
        if (_oldId != viewId)
        {
            stupidStore = new();
            componentList = new();
            _oldId = viewId;
        }

        // Fetch the appView via the gRPC call
        appView = await AppViewRepository.GetAppViewById(viewId.Value);

        if (appView != null && appView.Content != null)
        {
            // Deserialize the Content byte array into a UIComponentList
            componentList = UIComponentList.Parser.ParseFrom(appView.Content);
        }
        else
        {
            // Handle the case where the AppView is null or Content is null
            componentList = new UIComponentList();
        }
        _isLoading = false;
    }
}

